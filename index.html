<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <title>è¦ä¹–å“¦ | Be Good V15.0 Ultimate</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        /* 1. é£æ ¼å›å½’ï¼šæ¸©é¦¨ã€æŸ”è½¯ã€æ¸å˜ */
        :root { --accent: #ff7eb9; --accent-deep: #db2777; --bg-gradient: linear-gradient(135deg, #fdfbfb 0%, #ebedee 100%); }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg-gradient); min-height: 100vh; padding-top: 240px; padding-bottom: 110px; color: #334155; }
        
        /* ç»ç’ƒæ‹Ÿæ€å¡ç‰‡ */
        .glass-card { background: rgba(255,255,255,0.85); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.6); border-radius: 20px; box-shadow: 0 8px 32px rgba(0,0,0,0.03); }
        .fixed-header { position: fixed; top: 0; left: 0; right: 0; z-index: 50; background: rgba(255,255,255,0.95); backdrop-filter: blur(20px); border-bottom: 1px solid rgba(0,0,0,0.05); padding: 1.2rem; }
        
        /* äº¤äº’ç»„ä»¶ */
        .check-custom { appearance: none; width: 24px; height: 24px; border: 2px solid #cbd5e1; border-radius: 8px; transition: 0.2s; position: relative; cursor: pointer; }
        .check-custom:checked { background: var(--accent); border-color: var(--accent); }
        .check-custom:checked::after { content: 'âœ”'; position: absolute; color: white; left: 5px; top: 0; font-size: 14px; font-weight: bold; }
        .tab-btn { color: #94a3b8; transition: 0.3s; }
        .tab-btn.active { color: var(--accent-deep); transform: scale(1.1); font-weight: 800; }
        .hidden { display: none !important; }
        
        /* è¾“å…¥æ¡†ç¾åŒ– */
        input, select { background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; outline: none; transition: 0.2s; text-align: center; }
        input:focus, select:focus { border-color: var(--accent); background: white; }

        /* åŠ¨ç”» */
        @keyframes breathe { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        .animate-breathe { animation: breathe 3s infinite ease-in-out; }
    </style>
</head>
<body>

    <header class="fixed-header">
        <div class="flex justify-between items-start mb-3">
            <div>
                <h1 class="text-2xl font-black italic tracking-tighter text-gray-800">è¦ä¹–å“¦<span class="text-pink-500">.</span></h1>
                <p class="text-[10px] text-gray-400 font-bold mt-1" id="currentDateDisplay">LOADING...</p>
            </div>
            <div class="text-right">
                <div class="bg-gray-900 text-white px-3 py-1 rounded-lg inline-block shadow-lg">
                    <p class="text-[8px] opacity-60 uppercase tracking-widest">TIMELINE</p>
                    <p class="text-xs font-bold" id="timelineDisplay">Day 1</p>
                </div>
            </div>
        </div>

        <div class="glass-card p-3 mb-2 grid grid-cols-2 gap-3">
            <div>
                <p class="text-[8px] text-gray-400 font-bold mb-1 uppercase">æ€§åˆ« & ç›®æ ‡æ—¥æœŸ</p>
                <div class="flex gap-2">
                    <select id="p_gender" onchange="saveProfile()" class="w-1/2 text-xs font-bold py-1">
                        <option value="female">å¥³ ğŸ‘§</option>
                        <option value="male">ç”· ğŸ‘¦</option>
                    </select>
                    <input id="p_goal_date" type="date" onchange="saveProfile()" class="w-1/2 text-[10px] font-bold py-1 text-gray-500">
                </div>
            </div>
            <div>
                <p class="text-[8px] text-gray-400 font-bold mb-1 uppercase">åˆå§‹è…°å›´ & åˆå§‹ä½“é‡</p>
                <div class="flex gap-2">
                    <input id="p_init_waist" type="number" oninput="saveProfile()" placeholder="CM" class="w-1/2 text-xs font-bold py-1 text-pink-600">
                    <input id="p_init_weight" type="number" oninput="saveProfile()" placeholder="KG" class="w-1/2 text-xs font-bold py-1 text-blue-600">
                </div>
            </div>
        </div>
        
        <div class="flex justify-between items-center bg-white/50 px-3 py-2 rounded-lg border border-white">
            <span class="text-[10px] text-gray-500 font-bold">WHtR (è…°é«˜æ¯”): <span id="whtr_val" class="text-lg text-gray-800 font-black ml-1">--</span></span>
            <span id="whtr_tag" class="text-[9px] px-2 py-1 rounded bg-gray-200 text-gray-500 font-bold">å¾…å®Œå–„èµ„æ–™</span>
        </div>
    </header>

    <main class="px-5">
        
        <div id="tab-tasks" class="space-y-4 pb-24">
            <div class="glass-card p-4 bg-gradient-to-r from-pink-50 to-white border-pink-100">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="text-xs font-black text-pink-500 uppercase"><i class="fa-solid fa-pen-to-square mr-1"></i> ä»Šæ—¥è®°å½•</h3>
                    <span class="text-[9px] text-gray-400">æ¯æ—¥æ›´æ–°ï¼Œç”Ÿæˆå›¾è¡¨</span>
                </div>
                <div class="flex gap-3">
                    <div class="w-1/2 relative">
                        <input id="today_waist" type="number" oninput="saveDaily()" class="w-full h-10 font-bold text-lg" placeholder="0.0">
                        <span class="absolute right-3 top-3 text-[10px] text-gray-400">CM</span>
                    </div>
                    <div class="w-1/2 relative">
                        <input id="today_weight" type="number" oninput="saveDaily()" class="w-full h-10 font-bold text-lg" placeholder="0.0">
                        <span class="absolute right-3 top-3 text-[10px] text-gray-400">KG</span>
                    </div>
                </div>
            </div>
            
            <div id="taskListArea"></div>
        </div>

        <div id="tab-profile" class="hidden space-y-4 pb-24">
            
            <div class="glass-card p-5 border-l-4 border-pink-400">
                <h3 class="text-sm font-black text-gray-800 mb-3">ğŸ¯ ç›®æ ‡è®¾å®š</h3>
                <div class="space-y-3">
                    <div>
                        <label class="text-xs text-gray-500 font-bold">æ‚¨çš„èº«é«˜ (CM)</label>
                        <input id="p_height" type="number" oninput="calcRecommendation()" class="w-full h-10 mt-1 font-bold text-gray-700">
                    </div>
                    
                    <div class="bg-blue-50 p-3 rounded-lg border border-blue-100">
                        <p class="text-[10px] text-blue-500 font-bold mb-1">ğŸ’¡ ç³»ç»Ÿæ¨èç›®æ ‡è…°å›´ (0.37-0.42)</p>
                        <p id="rec_goal_display" class="text-lg font-black text-blue-700">-- cm</p>
                    </div>

                    <div>
                        <label class="text-xs text-gray-500 font-bold">è®¾å®šæ‚¨çš„ç›®æ ‡è…°å›´ (CM)</label>
                        <input id="p_goal" type="number" oninput="checkGoalSafety()" class="w-full h-10 mt-1 font-bold text-green-600 border-green-200 bg-green-50">
                        <p id="goal_alert" class="hidden text-[10px] text-red-500 mt-1 font-bold"><i class="fa-solid fa-circle-exclamation"></i> ç›®æ ‡è®¾å®šåé«˜å“¦ï¼Œå»ºè®®è°ƒæ•´è‡³æ¨èèŒƒå›´å†…ä»¥è·å¾—æœ€ä½³å¥åº·æ”¶ç›Šã€‚</p>
                    </div>
                </div>
            </div>

            <div class="glass-card p-5">
                <h3 class="text-sm font-black text-gray-800 mb-3">ğŸ“ è¯¦ç»†æµ‹é‡æ•°æ®</h3>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="text-[10px] text-gray-400">è‚‹éª¨å›´ (cm)</label><input id="p_ribs" type="number" onchange="saveProfile()" class="w-full mt-1"></div>
                    <div><label class="text-[10px] text-gray-400">è…•å›´ (cm)</label><input id="p_wrist" type="number" onchange="saveProfile()" class="w-full mt-1"></div>
                    <div><label class="text-[10px] text-gray-400">è…°éƒ¨æœ€ç»†å¤„ (è‚‹éª¨ä¸‹)</label><input id="p_waist_min" type="number" onchange="saveProfile()" class="w-full mt-1"></div>
                    <div><label class="text-[10px] text-gray-400">è…°éƒ¨æœ€å®½å¤„ (è¿‡è‚šè„)</label><input id="p_waist_max" type="number" oninput="calcRecommendation()" class="w-full mt-1"></div>
                </div>
            </div>

            <div class="glass-card p-5">
                <h3 class="text-sm font-black text-gray-800 mb-3">ğŸ“¸ ä½“æ€è¿½è¸ª</h3>
                <div class="border-2 border-dashed border-gray-200 rounded-xl p-6 bg-gray-50 text-center relative hover:bg-white transition-all cursor-pointer" onclick="document.getElementById('side_photo').click()">
                    <input type="file" id="side_photo" class="hidden" accept="image/*" onchange="previewImg(this)">
                    <div id="photo_preview_area">
                        <i class="fa-solid fa-camera text-3xl text-gray-300 mb-2"></i>
                        <p class="text-xs text-gray-400 font-bold">ä¸Šä¼ ä¾§é¢ç…§</p>
                        <p class="text-[8px] text-gray-400 mt-1">è¯·ç©¿åŒæ¬¾è¡£ç‰© Â· åŒä¸€é•œå‰æ‹æ‘„</p>
                    </div>
                </div>
            </div>

            <div class="glass-card p-5">
                <h3 class="text-sm font-black text-gray-800 mb-3">ğŸ¥— ç”Ÿæ´»ç”»åƒ</h3>
                <div class="space-y-3">
                    <select id="p_job" onchange="saveProfile()" class="w-full h-9 text-xs"><option value="">-- é€‰æ‹©èŒä¸šç±»å‹ --</option><option>ä¹…ååŠå…¬æ—</option><option>ç«™ç«‹æœåŠ¡ä¸š</option><option>ä½“åŠ›åŠ³åŠ¨è€…</option><option>è‡ªç”±èŒä¸š/å±…å®¶</option></select>
                    <select id="p_sport" onchange="saveProfile()" class="w-full h-9 text-xs"><option value="">-- é€‰æ‹©è¿åŠ¨é¢‘ç‡ --</option><option>å‡ ä¹ä¸è¿åŠ¨</option><option>æ¯å‘¨ 1-2 æ¬¡è½»åº¦</option><option>æ¯å‘¨ 3-5 æ¬¡ä¸­é«˜å¼ºåº¦</option><option>ä¸“ä¸šè®­ç»ƒè€…</option></select>
                    <select id="p_diet" onchange="saveProfile()" class="w-full h-9 text-xs"><option value="">-- é€‰æ‹©é¥®é£Ÿåå¥½ --</option><option>å‡è¡¡æ‚é£Ÿ</option><option>ä½ç¢³æ°´/ç”Ÿé…®</option><option>ç´ é£Ÿä¸»ä¹‰</option><option>å¤–å–/é«˜æ²¹ç›</option></select>
                </div>
            </div>
        </div>

        <div id="tab-social" class="hidden pb-24 text-center pt-10">
            <div class="glass-card p-8 mx-auto w-3/4">
                <i class="fa-solid fa-comments text-4xl text-pink-200 mb-4"></i>
                <p class="text-sm text-gray-500">ç¤¾äº¤æ¨¡å—è¿è¡Œæ­£å¸¸</p>
            </div>
        </div>

        <div id="tab-stats" class="hidden space-y-5 pb-24">
            <div class="glass-card p-4">
                <h3 class="text-xs font-black text-gray-400 mb-3 uppercase">è¿‘7å¤©æ‰“å¡ç»Ÿè®¡</h3>
                <canvas id="chartHabit" height="150"></canvas>
            </div>
            <div class="glass-card p-4">
                <h3 class="text-xs font-black text-gray-400 mb-3 uppercase">ä½“é‡è¶‹åŠ¿ (KG)</h3>
                <canvas id="chartWeight" height="150"></canvas>
            </div>
            <div class="glass-card p-4">
                <h3 class="text-xs font-black text-gray-400 mb-3 uppercase">è…°å›´è¶‹åŠ¿ (CM)</h3>
                <canvas id="chartWaist" height="150"></canvas>
            </div>
        </div>
    </main>

    <div id="mediaOverlay" class="hidden fixed inset-0 bg-white/95 z-[100] flex flex-col items-center justify-center p-8 text-center transition-all duration-500">
        <div id="visualCircle" class="w-64 h-64 bg-pink-100 rounded-full flex items-center justify-center mb-10 shadow-2xl animate-breathe hidden">
            <span class="text-4xl">ğŸ§˜â€â™€ï¸</span>
        </div>
        <div id="visualMusic" class="text-6xl animate-bounce mb-10 hidden text-pink-500">ğŸµ</div>
        
        <h2 id="mediaTitle" class="text-3xl font-black mb-2 text-gray-800">å‡†å¤‡å¼€å§‹</h2>
        <p id="mediaTimer" class="text-6xl font-black text-pink-500 tabular-nums my-4">00:00</p>
        <p id="mediaSubtitle" class="text-gray-500 text-sm h-12">ä¿æŒä¸“æ³¨...</p>
        
        <button onclick="stopMedia()" class="mt-8 px-12 py-4 bg-gray-900 text-white rounded-full font-bold shadow-lg hover:scale-105 transition-transform">ç»“æŸè®­ç»ƒ</button>
    </div>

    <nav class="fixed bottom-6 left-4 right-4 h-16 glass-card flex justify-around items-center px-2 z-50">
        <button onclick="switchTab('tasks')" class="tab-btn active w-1/4 text-xl"><i class="fa-solid fa-list-check"></i><span class="block text-[9px] font-bold mt-1">æ‰“å¡</span></button>
        <button onclick="switchTab('social')" class="tab-btn w-1/4 text-xl"><i class="fa-solid fa-users"></i><span class="block text-[9px] font-bold mt-1">åœˆå­</span></button>
        <button onclick="switchTab('stats')" class="tab-btn w-1/4 text-xl"><i class="fa-solid fa-chart-line"></i><span class="block text-[9px] font-bold mt-1">æŠ¥è¡¨</span></button>
        <button onclick="switchTab('profile')" class="tab-btn w-1/4 text-xl"><i class="fa-solid fa-user-gear"></i><span class="block text-[9px] font-bold mt-1">æˆ‘çš„</span></button>
    </nav>

    <script>
        // --- V15 æ ¸å¿ƒæ•°æ®ç»“æ„ ---
        const DB_KEY = 'begood_v15_pro';
        let db = {};
        let audioCtx = null;
        let activeInterval = null;
        let isPlaying = false;
        const synth = window.speechSynthesis;

        // V13 å…¨é‡ä»»åŠ¡åˆ—è¡¨ (ç»ä¸åˆ å‡)
        const TASKS_WORKDAY = [
            { t:'07:00', txt:'èµ·åºŠï¼šæ¸©æ°´ 300ml' }, { t:'07:05', txt:'çœŸç©ºè…¹å‘¼å¸ 3ç»„', type:'vacuum' },
            { t:'07:20', txt:'ç«™å§¿å”¤é†’ 2åˆ†é’Ÿ' }, { t:'07:30', txt:'æ—©é¤ï¼šè›‹ç™½+è”¬èœ' },
            { t:'07:45', txt:'å‡ºå‘å»å…¬å¸' }, { t:'09:00', txt:'å¼€å¯å·¥ä½œæ¨¡å¼' },
            { t:'10:00', txt:'èµ·èº«æ´»åŠ¨+å–æ°´' }, { t:'11:00', txt:'èµ·èº«æ´»åŠ¨+å–æ°´' },
            { t:'12:30', txt:'åˆé¤ï¼šç¢³æ°´+è›‹ç™½+è”¬èœ' }, { t:'12:55', txt:'é¤åæ…¢èµ° 15åˆ†é’Ÿ', type:'walk' },
            { t:'14:30', txt:'èµ·èº«+å–æ°´' }, { t:'15:30', txt:'èµ·èº«+å–æ°´' },
            { t:'16:30', txt:'èµ·èº«+å–æ°´' }, { t:'18:10', txt:'å¼€è½¦å›å®¶' },
            { t:'19:00', txt:'åŠ›é‡/æœ‰æ°§è®­ç»ƒ' }, { t:'20:00', txt:'æ™šé¤ï¼šè›‹ç™½+è”¬èœ+å°‘ç›' },
            { t:'21:00', txt:'çœŸç©ºè…¹å‘¼å¸ 3ç»„', type:'vacuum' }, { t:'21:15', txt:'æ‹‰ä¼¸ã€æ”¾æ¾' },
            { t:'22:30', txt:'ä¸ŠåºŠå…¥ç¡' }
        ];
        const TASKS_WEEKEND = [
            { t:'09:30', txt:'èµ·åºŠï¼šæ¸©æ°´ 300ml' }, { t:'09:35', txt:'çœŸç©ºè…¹å‘¼å¸ 3ç»„', type:'vacuum' },
            { t:'09:50', txt:'ç«™å§¿å”¤é†’ 2åˆ†é’Ÿ' }, { t:'10:00', txt:'æ—©é¤ï¼šè›‹ç™½+è”¬èœ' },
            { t:'12:00', txt:'åˆé¤ï¼šç¢³æ°´+è›‹ç™½+è”¬èœ' }, { t:'13:30', txt:'é¤åæ…¢èµ° 15åˆ†é’Ÿ', type:'walk' },
            { t:'19:00', txt:'æœ‰æ°§è®­ç»ƒ' }, { t:'20:00', txt:'æ™šé¤ï¼šè›‹ç™½+è”¬èœ+å°‘ç›' },
            { t:'21:00', txt:'çœŸç©ºè…¹å‘¼å¸ 3ç»„', type:'vacuum' }, { t:'21:15', txt:'æ‹‰ä¼¸ã€æ”¾æ¾' },
            { t:'23:30', txt:'ä¸ŠåºŠå…¥ç¡' }
        ];

        window.onload = () => {
            initDB();
            renderHeader();
            renderTaskList();
            loadProfileToUI();
            loadDailyToUI();
        };

        function initDB() {
            const raw = localStorage.getItem(DB_KEY);
            if (raw) {
                db = JSON.parse(raw);
            } else {
                db = {
                    startDate: new Date().toISOString().split('T')[0],
                    profile: { 
                        gender:'female', init_waist:'', init_weight:'', goal_date:'', height:'', goal:'', 
                        ribs:'', wrist:'', waist_min:'', waist_max:'', 
                        job:'', sport:'', diet:'', photoData:'' 
                    },
                    history: {}
                };
                saveDB();
            }
        }

        function saveDB() { localStorage.setItem(DB_KEY, JSON.stringify(db)); }

        // --- 1. ç•Œé¢ä¸äº¤äº’ ---
        function renderHeader() {
            const now = new Date();
            document.getElementById('currentDateDisplay').innerText = now.toLocaleDateString('zh-CN', {month:'long', day:'numeric', weekday:'long'});
            
            const start = new Date(db.startDate);
            const diff = Math.floor((now - start) / (1000*60*60*24)) + 1;
            document.getElementById('timelineDisplay').innerText = `Day ${diff}`;
        }

        // --- 2. æ¡£æ¡ˆä¸è®¡ç®—é€»è¾‘ (V15æ–°å¢) ---
        function saveProfile() {
            const p = db.profile;
            p.gender = document.getElementById('p_gender').value;
            p.goal_date = document.getElementById('p_goal_date').value;
            p.init_waist = document.getElementById('p_init_waist').value;
            p.init_weight = document.getElementById('p_init_weight').value;
            
            // Tab 4 Profile Fields
            p.height = document.getElementById('p_height').value;
            p.ribs = document.getElementById('p_ribs').value;
            p.wrist = document.getElementById('p_wrist').value;
            p.waist_min = document.getElementById('p_waist_min').value;
            p.waist_max = document.getElementById('p_waist_max').value;
            p.goal = document.getElementById('p_goal').value;
            
            p.job = document.getElementById('p_job').value;
            p.sport = document.getElementById('p_sport').value;
            p.diet = document.getElementById('p_diet').value;

            saveDB();
            calcRecommendation(); // å®æ—¶è®¡ç®—
        }

        function loadProfileToUI() {
            const p = db.profile;
            ['p_gender','p_goal_date','p_init_waist','p_init_weight','p_height','p_ribs','p_wrist','p_waist_min','p_waist_max','p_goal','p_job','p_sport','p_diet'].forEach(id => {
                const el = document.getElementById(id);
                if(el && p[id.replace('p_','')]) el.value = p[id.replace('p_','')]; // mapping correction
                if(id === 'p_gender') el.value = p.gender; // manual fix for non-standard mapping
                if(id === 'p_job') el.value = p.job;
                if(id === 'p_sport') el.value = p.sport;
                if(id === 'p_diet') el.value = p.diet;
                if(id === 'p_goal') el.value = p.goal;
                if(id === 'p_goal_date') el.value = p.goal_date;
                if(id === 'p_init_waist') el.value = p.init_waist;
                if(id === 'p_init_weight') el.value = p.init_weight;
                if(id === 'p_height') el.value = p.height;
                if(id === 'p_waist_min') el.value = p.waist_min;
                if(id === 'p_waist_max') el.value = p.waist_max;
                if(id === 'p_ribs') el.value = p.ribs;
                if(id === 'p_wrist') el.value = p.wrist;
            });
            
            if(p.photoData) {
                document.getElementById('photo_preview_area').innerHTML = `<img src="${p.photoData}" class="h-32 rounded-lg mx-auto shadow-md">`;
            }
            calcRecommendation();
        }

        // --- æ™ºèƒ½è®¡ç®—å¼•æ“ ---
        function calcRecommendation() {
            const h = parseFloat(db.profile.height);
            // 1. æ¨èè…°å›´ (0.37 - 0.42)
            if (h > 0) {
                const min = (h * 0.37).toFixed(1);
                const max = (h * 0.42).toFixed(1);
                document.getElementById('rec_goal_display').innerText = `${min} - ${max} cm`;
            }

            // 2. WHtR è®¡ç®—
            // ä¼˜å…ˆä½¿ç”¨ä»Šæ—¥æµ‹é‡çš„ waist_max (è¿‡è‚šè„)ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨åˆå§‹
            const w = parseFloat(db.profile.waist_max) || parseFloat(db.profile.init_waist);
            
            if (h > 0 && w > 0) {
                const whtr = (w / h).toFixed(2);
                const el = document.getElementById('whtr_val');
                const tag = document.getElementById('whtr_tag');
                
                el.innerText = whtr;
                if(whtr <= 0.42) { tag.innerText = "æä½³"; tag.className = "text-[9px] px-2 py-1 rounded bg-green-100 text-green-600 font-bold"; }
                else if(whtr <= 0.48) { tag.innerText = "å¥åº·"; tag.className = "text-[9px] px-2 py-1 rounded bg-blue-100 text-blue-600 font-bold"; }
                else { tag.innerText = "éœ€æ³¨æ„"; tag.className = "text-[9px] px-2 py-1 rounded bg-orange-100 text-orange-600 font-bold"; }
            }
            checkGoalSafety();
        }

        function checkGoalSafety() {
            const h = parseFloat(db.profile.height);
            const userGoal = parseFloat(document.getElementById('p_goal').value);
            const alertBox = document.getElementById('goal_alert');
            
            if(h > 0 && userGoal > 0) {
                const safeMax = h * 0.44; // ç¨å¾®æ”¾å®½ä¸€ç‚¹ç‚¹è§¦å‘è­¦å‘Š
                if (userGoal > safeMax) {
                    alertBox.classList.remove('hidden');
                } else {
                    alertBox.classList.add('hidden');
                }
            }
        }

        function previewImg(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = e => {
                    db.profile.photoData = e.target.result;
                    saveDB();
                    document.getElementById('photo_preview_area').innerHTML = `<img src="${e.target.result}" class="h-32 rounded-lg mx-auto shadow-md">`;
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        // --- 3. æ‰“å¡ç³»ç»Ÿ (æ¯æ—¥é‡ç½® & å†å²è®°å½•) ---
        function renderTaskList() {
            const isWeekend = [0,6].includes(new Date().getDay());
            const todayKey = new Date().toISOString().split('T')[0];
            if(!db.history[todayKey]) db.history[todayKey] = { checks: [] };

            const list = isWeekend ? TASKS_WEEKEND : TASKS_WORKDAY;
            
            document.getElementById('taskListArea').innerHTML = list.map((item, idx) => {
                const checked = db.history[todayKey].checks[idx] || false;
                return `
                <div class="glass-card p-4 flex justify-between items-center transition-all ${checked ? 'opacity-50' : ''}">
                    <div class="flex gap-4 items-start">
                        <span class="text-[10px] font-black text-gray-400 mt-1 w-8">${item.t}</span>
                        <div>
                            <p class="font-bold text-gray-700 text-sm ${checked ? 'line-through' : ''}">${item.txt}</p>
                            ${item.type==='vacuum'?`<button onclick="startVacuum()" class="mt-2 text-[9px] bg-pink-500 text-white px-3 py-1 rounded-full shadow hover:bg-pink-600"><i class="fa-solid fa-wind mr-1"></i>è¯­éŸ³å¼•å¯¼</button>`:''}
                            ${item.type==='walk'?`<button onclick="startMusic()" class="mt-2 text-[9px] bg-blue-500 text-white px-3 py-1 rounded-full shadow hover:bg-blue-600"><i class="fa-solid fa-music mr-1"></i>å¼€å§‹æ…¢èµ°(éŸ³ä¹)</button>`:''}
                        </div>
                    </div>
                    <input type="checkbox" class="check-custom" ${checked?'checked':''} onchange="toggleTask(${idx})">
                </div>
                `
            }).join('');
        }

        function toggleTask(idx) {
            const k = new Date().toISOString().split('T')[0];
            db.history[k].checks[idx] = !db.history[k].checks[idx];
            saveDB();
            renderTaskList();
        }

        function saveDaily() {
            const k = new Date().toISOString().split('T')[0];
            db.history[k].weight = document.getElementById('today_weight').value;
            db.history[k].waist = document.getElementById('today_waist').value;
            saveDB();
            if(!document.getElementById('tab-stats').classList.contains('hidden')) renderCharts();
        }

        function loadDailyToUI() {
            const k = new Date().toISOString().split('T')[0];
            if(db.history[k]) {
                document.getElementById('today_weight').value = db.history[k].weight || '';
                document.getElementById('today_waist').value = db.history[k].waist || '';
            }
        }

        // --- 4. éŸ³é¢‘å¼•æ“ (ä¿ç•™ V13 æ ¸å¿ƒ) ---
        function startVacuum() {
            showMedia('v');
            document.getElementById('mediaTitle').innerText = "çœŸç©ºè…¹è®­ç»ƒ";
            speak("å‡†å¤‡å§¿åŠ¿...å…¨èº«æ”¾æ¾...æ·±å¸æ°”...å‘¼æ°”...æ”¶ç´§è…¹éƒ¨ï¼Œä¿æŒï¼", () => stopMedia());
        }

        function startMusic() {
            showMedia('m');
            document.getElementById('mediaTitle').innerText = "æ¬¢å¿«æ…¢èµ°";
            if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            audioCtx.resume();
            isPlaying = true;
            playMelody(); // å¯åŠ¨æ—‹å¾‹
            let t = 900;
            activeInterval = setInterval(() => {
                t--;
                document.getElementById('mediaTimer').innerText = `${Math.floor(t/60)}:${(t%60).toString().padStart(2,'0')}`;
                if(t<=0) stopMedia();
            }, 1000);
        }

        function showMedia(type) {
            document.getElementById('mediaOverlay').classList.remove('hidden');
            document.getElementById('visualCircle').classList.add('hidden');
            document.getElementById('visualMusic').classList.add('hidden');
            if(type==='v') document.getElementById('visualCircle').classList.remove('hidden');
            if(type==='m') document.getElementById('visualMusic').classList.remove('hidden');
        }

        function stopMedia() {
            document.getElementById('mediaOverlay').classList.add('hidden');
            synth.cancel();
            isPlaying = false;
            clearInterval(activeInterval);
            if(audioCtx) audioCtx.suspend();
        }

        function playMelody() {
            if(!isPlaying) return;
            const notes = [261.6, 329.6, 392.0, 523.2, 392.0, 329.6]; 
            let idx = 0;
            const next = () => {
                if(!isPlaying) return;
                const osc = audioCtx.createOscillator();
                const g = audioCtx.createGain();
                osc.type = 'triangle';
                osc.frequency.value = notes[idx%notes.length];
                g.gain.setValueAtTime(0.1, audioCtx.currentTime);
                g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime+0.2);
                osc.connect(g); g.connect(audioCtx.destination);
                osc.start(); osc.stop(audioCtx.currentTime+0.25);
                idx++;
                setTimeout(next, 250);
            };
            next();
        }

        function speak(txt, cb) {
            const u = new SpeechSynthesisUtterance(txt);
            u.rate = 0.9;
            u.onend = cb; 
            synth.speak(u);
        }

        // --- 5. å›¾è¡¨ä¸åˆ‡æ¢ ---
        let chartRefs = {};
        function renderCharts() {
            const labels = []; const dW = []; const dWa = []; const dT = [];
            for(let i=6; i>=0; i--) {
                const d = new Date(); d.setDate(d.getDate()-i);
                const k = d.toISOString().split('T')[0];
                labels.push(d.getDate()+'æ—¥');
                const h = db.history[k] || {};
                dW.push(h.weight||null); dWa.push(h.waist||null); dT.push((h.checks||[]).filter(Boolean).length);
            }
            drawChart('chartHabit', 'bar', labels, dT, '#ff7eb9');
            drawChart('chartWeight', 'line', labels, dW, '#3b82f6');
            drawChart('chartWaist', 'line', labels, dWa, '#10b981');
        }

        function drawChart(id, type, l, d, c) {
            if(chartRefs[id]) chartRefs[id].destroy();
            chartRefs[id] = new Chart(document.getElementById(id), {
                type, data:{labels:l, datasets:[{label:'æ•°å€¼', data:d, borderColor:c, backgroundColor:c, tension:0.4}]},
                options:{responsive:true, plugins:{legend:{display:false}}}
            });
        }

        function switchTab(t) {
            ['tasks','profile','social','stats'].forEach(x => document.getElementById('tab-'+x).classList.add('hidden'));
            document.getElementById('tab-'+t).classList.remove('hidden');
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            event.currentTarget.classList.add('active');
            if(t==='stats') renderCharts();
            if(t==='profile') loadProfileToUI();
        }
    </script>
</body>
</html>
