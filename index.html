<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <title>要乖哦 | Be Good V11.0 Ultimate</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        :root { --accent: #ff7eb9; --bg-gradient: linear-gradient(135deg, #fff0f5 0%, #eef2ff 100%); }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg-gradient); min-height: 100vh; padding-top: 180px; padding-bottom: 100px; }
        
        /* 玻璃拟态卡片 */
        .glass-card { background: rgba(255,255,255,0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.6); border-radius: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); }
        .fixed-header { position: fixed; top: 0; left: 0; right: 0; z-index: 50; background: rgba(255,255,255,0.85); backdrop-filter: blur(20px); border-bottom: 1px solid rgba(255,255,255,0.3); padding: 1.2rem; }
        
        /* 交互动画 */
        .tab-btn { transition: all 0.3s; opacity: 0.5; }
        .tab-btn.active { opacity: 1; transform: scale(1.1); color: var(--accent); }
        .progress-fill { transition: width 1.2s cubic-bezier(0.4, 0, 0.2, 1); }
        .hidden { display: none !important; }
        
        /* 任务打卡勾选框 */
        .check-custom { appearance: none; width: 24px; height: 24px; border: 2px solid #cbd5e1; border-radius: 8px; transition: 0.2s; position: relative; }
        .check-custom:checked { background: var(--accent); border-color: var(--accent); }
        .check-custom:checked::after { content: '✓'; position: absolute; color: white; left: 6px; top: 0; font-weight: bold; }

        /* 分享预览层 */
        #shareOverlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 200; display: none; align-items: center; justify-content: center; flex-direction: column; }
    </style>
</head>
<body>

    <header class="fixed-header shadow-sm">
        <div class="flex justify-between items-center mb-3">
            <h1 class="text-2xl font-black italic tracking-tighter">要乖哦<span class="text-pink-500">.</span></h1>
            <span id="modeLabel" class="text-[9px] font-bold bg-black text-white px-3 py-1 rounded-full uppercase">LOADING</span>
        </div>
        
        <div class="grid grid-cols-4 gap-2 mb-3">
            <div class="bg-gray-50 rounded-xl p-2 text-center"><p class="text-[8px] font-bold text-gray-400">身高</p><input id="p_h" type="number" oninput="saveData()" class="w-full bg-transparent text-center font-black outline-none" placeholder="-"></div>
            <div class="bg-gray-50 rounded-xl p-2 text-center"><p class="text-[8px] font-bold text-gray-400">体重</p><input id="p_w" type="number" oninput="saveData()" class="w-full bg-transparent text-center font-black outline-none" placeholder="-"></div>
            <div class="bg-pink-50 rounded-xl p-2 text-center"><p class="text-[8px] font-bold text-pink-400">腰围</p><input id="p_c" type="number" oninput="saveData()" class="w-full bg-transparent text-center font-black outline-none text-pink-600" placeholder="-"></div>
            <div class="bg-green-50 rounded-xl p-2 text-center"><p class="text-[8px] font-bold text-green-500">目标</p><input id="p_t" type="number" oninput="saveData()" class="w-full bg-transparent text-center font-black outline-none text-green-600" placeholder="-"></div>
        </div>

        <div class="w-full h-3 bg-gray-200 rounded-full overflow-hidden relative">
            <div id="waistProgress" class="h-full bg-gradient-to-r from-pink-300 to-pink-600 progress-fill" style="width: 0%"></div>
        </div>
        <p class="text-[9px] text-right text-gray-400 mt-1" id="progressText">加油，距离目标还有...</p>
    </header>

    <main id="appBody" class="px-5">
        
        <div id="tab-tasks" class="space-y-3 pb-24">
            </div>

        <div id="tab-social" class="hidden space-y-4 pb-24">
            <div class="glass-card p-4">
                <textarea id="socialText" placeholder="今天感觉怎么样？(支持文字、图片、7分钟内短视频)" class="w-full bg-transparent outline-none text-sm h-16"></textarea>
                <div class="flex items-center gap-4 mt-2 border-t pt-2">
                    <label class="text-pink-500 cursor-pointer"><i class="fa-solid fa-image"></i><input type="file" id="socialImg" accept="image/*" class="hidden"></label>
                    <label class="text-blue-500 cursor-pointer"><i class="fa-solid fa-video"></i><input type="file" id="socialVid" accept="video/*" class="hidden" onchange="validateVideo(this)"></label>
                    <button onclick="postFeed()" class="ml-auto bg-black text-white px-4 py-1 rounded-full text-xs font-bold">发布</button>
                </div>
            </div>
            <div id="feedArea" class="space-y-4"></div>
        </div>

        <div id="tab-stats" class="hidden space-y-5 pb-24">
            <button onclick="createShareCard()" class="w-full py-3 bg-gradient-to-r from-pink-500 to-purple-500 text-white rounded-xl font-bold shadow-lg flex items-center justify-center gap-2">
                <i class="fa-solid fa-share-nodes"></i> 生成今日成就卡片
            </button>
            
            <div class="glass-card p-4">
                <h3 class="text-xs font-black text-gray-400 mb-3 uppercase">本周打卡统计</h3>
                <canvas id="chartHabit" height="150"></canvas>
            </div>
            <div class="glass-card p-4">
                <h3 class="text-xs font-black text-gray-400 mb-3 uppercase">体重变化 (KG)</h3>
                <canvas id="chartWeight" height="150"></canvas>
            </div>
            <div class="glass-card p-4">
                <h3 class="text-xs font-black text-gray-400 mb-3 uppercase">腰围变化 (CM)</h3>
                <canvas id="chartWaist" height="150"></canvas>
            </div>
        </div>
    </main>

    <div id="timerOverlay" class="hidden fixed inset-0 bg-white/95 backdrop-blur-2xl z-[100] flex flex-col items-center justify-center p-8 text-center">
        <div class="relative w-64 h-64 mb-8 flex items-center justify-center">
            <div class="absolute inset-0 bg-pink-100 rounded-full animate-ping opacity-30"></div>
            <div class="relative bg-white w-full h-full rounded-full flex items-center justify-center shadow-xl border border-pink-50">
                <span id="timerDisplay" class="text-6xl font-black text-gray-800 tabular-nums">00:00</span>
            </div>
        </div>
        <h2 id="timerTitle" class="text-2xl font-black mb-2">准备开始</h2>
        <p id="timerSubtitle" class="text-gray-500 text-sm h-20 px-4 italic leading-relaxed flex items-center justify-center">请调大音量，放松身心...</p>
        <button onclick="stopAll()" class="mt-8 px-12 py-4 bg-gray-900 text-white rounded-full font-bold shadow-lg active:scale-95 transition">结束训练</button>
    </div>

    <div id="shareOverlay" onclick="this.style.display='none'">
        <div id="captureTarget" class="bg-white p-8 rounded-[30px] w-72 text-center relative overflow-hidden shadow-2xl">
            <div class="absolute -top-10 -right-10 w-32 h-32 bg-pink-100 rounded-full blur-xl"></div>
            <h2 class="text-3xl font-black italic mb-1">要乖哦<span class="text-pink-500">.</span></h2>
            <p class="text-[10px] text-gray-400 tracking-widest uppercase mb-6">自律进化记录</p>
            <div class="bg-gray-50 p-4 rounded-2xl mb-4">
                <p class="text-xs text-gray-500">累计缩减腰围</p>
                <p id="shareWaistDiff" class="text-4xl font-black text-pink-500 my-1">-0.0</p>
                <p class="text-[10px] text-gray-300">CM</p>
            </div>
            <div class="flex justify-between items-end border-t border-dashed pt-4">
                <div class="text-left">
                    <p class="text-[10px] font-bold" id="shareDate">2026.02.08</p>
                    <p class="text-[8px] text-gray-400">Keep Moving.</p>
                </div>
                <i class="fa-solid fa-qrcode text-2xl"></i>
            </div>
        </div>
        <p class="text-white text-xs mt-4 font-bold">长按上方卡片保存图片</p>
    </div>

    <nav class="fixed bottom-6 left-6 right-6 h-16 glass-card flex justify-around items-center px-2 z-50">
        <button onclick="switchTab('tasks')" class="tab-btn active w-1/3 text-xl"><i class="fa-solid fa-list-check"></i></button>
        <button onclick="switchTab('social')" class="tab-btn w-1/3 text-xl"><i class="fa-solid fa-users"></i></button>
        <button onclick="switchTab('stats')" class="tab-btn w-1/3 text-xl"><i class="fa-solid fa-chart-line"></i></button>
    </nav>

    <script>
        // --- 系统初始化与数据记忆 ---
        let audioCtx = null;
        let oscillators = [];
        let timerInt = null;
        const synth = window.speechSynthesis;

        window.onload = () => {
            loadData();
            renderTasks();
            renderFeed();
            // 预加载图表
            setTimeout(initCharts, 500);
        };

        function saveData() {
            const data = {
                h: document.getElementById('p_h').value,
                w: document.getElementById('p_w').value,
                c: document.getElementById('p_c').value,
                t: document.getElementById('p_t').value
            };
            localStorage.setItem('begood_v11_profile', JSON.stringify(data));
            updateProgress();
        }

        function loadData() {
            const data = JSON.parse(localStorage.getItem('begood_v11_profile'));
            if(data) {
                document.getElementById('p_h').value = data.h;
                document.getElementById('p_w').value = data.w;
                document.getElementById('p_c').value = data.c;
                document.getElementById('p_t').value = data.t;
                updateProgress();
            }
        }

        function updateProgress() {
            const cur = parseFloat(document.getElementById('p_c').value) || 0;
            const tar = parseFloat(document.getElementById('p_t').value) || 0;
            if(cur && tar) {
                const diff = (90 - cur); // 假设初始90
                const total = (90 - tar);
                let pct = (diff / total) * 100;
                pct = Math.max(0, Math.min(100, pct));
                document.getElementById('waistProgress').style.width = pct + "%";
                document.getElementById('progressText').innerText = `距离目标还需减掉 ${(cur - tar).toFixed(1)} cm`;
            }
        }

        // --- 核心任务逻辑 (完整 V5.0) ---
        function renderTasks() {
            const day = new Date().getDay();
            const isWeekend = (day === 0 || day === 6);
            document.getElementById('modeLabel').innerText = isWeekend ? "WEEKEND MODE" : "WORKDAY MODE";
            
            // 完整列表，一个不少
            let tasks = [];
            if(!isWeekend) {
                // 工作日
                tasks = [
                    { t:'07:00', txt:'起床：温水 300ml' },
                    { t:'07:05', txt:'真空腹呼吸 3组', type:'vacuum' },
                    { t:'07:20', txt:'站姿唤醒 2分钟' },
                    { t:'07:30', txt:'早餐：蛋白+蔬菜' },
                    { t:'07:45', txt:'出发去公司' },
                    { t:'09:00', txt:'开启工作模式' },
                    { t:'10:00', txt:'起身活动+喝水' },
                    { t:'11:00', txt:'起身活动+喝水' },
                    { t:'12:30', txt:'午餐：碳水+蛋白+蔬菜' },
                    { t:'12:55', txt:'餐后慢走 15分钟', type:'walk' },
                    { t:'14:30', txt:'起身+喝水' },
                    { t:'15:30', txt:'起身+喝水' },
                    { t:'16:30', txt:'起身+喝水' },
                    { t:'18:10', txt:'开车回家' },
                    { t:'19:00', txt: [1,3,5].includes(day)?'力量训练':'有氧训练' },
                    { t:'20:00', txt:'晚餐：蛋白+蔬菜+少盐' },
                    { t:'21:00', txt:'真空腹呼吸 3组', type:'vacuum' },
                    { t:'21:15', txt:'拉伸、放松' },
                    { t:'22:30', txt:'上床入睡' }
                ];
            } else {
                // 周末
                tasks = [
                    { t:'09:30', txt:'起床：温水 300ml' },
                    { t:'09:35', txt:'真空腹呼吸 3组', type:'vacuum' },
                    { t:'09:50', txt:'站姿唤醒 2分钟' },
                    { t:'10:00', txt:'早餐：蛋白+蔬菜' },
                    { t:'12:00', txt:'午餐：碳水+蛋白+蔬菜' },
                    { t:'13:30', txt:'餐后慢走 15分钟', type:'walk' },
                    { t:'19:00', txt:'有氧训练' },
                    { t:'20:00', txt:'晚餐：蛋白+蔬菜+少盐' },
                    { t:'21:00', txt:'真空腹呼吸 3组', type:'vacuum' },
                    { t:'21:15', txt:'拉伸、放松' },
                    { t:'23:30', txt:'上床入睡' }
                ];
            }

            const checks = JSON.parse(localStorage.getItem('daily_checks_' + new Date().toDateString())) || {};
            
            document.getElementById('tab-tasks').innerHTML = tasks.map((item, idx) => `
                <div class="glass-card p-4 flex justify-between items-center">
                    <div class="flex items-start gap-4">
                        <span class="text-[10px] font-black text-gray-400 mt-1 w-8">${item.t}</span>
                        <div>
                            <p class="font-bold text-gray-800 text-sm">${item.txt}</p>
                            ${item.type === 'vacuum' ? `<button onclick="startVacuum()" class="mt-2 text-[10px] bg-pink-500 text-white px-3 py-1 rounded-full"><i class="fa-solid fa-wind mr-1"></i>开始引导</button>` : ''}
                            ${item.type === 'walk' ? `<button onclick="startWalk()" class="mt-2 text-[10px] bg-blue-500 text-white px-3 py-1 rounded-full"><i class="fa-solid fa-person-walking mr-1"></i>开始慢走</button>` : ''}
                        </div>
                    </div>
                    <input type="checkbox" class="check-custom" ${checks[idx]?'checked':''} onchange="toggleTask(${idx})">
                </div>
            `).join('');
        }

        function toggleTask(idx) {
            const key = 'daily_checks_' + new Date().toDateString();
            const checks = JSON.parse(localStorage.getItem(key)) || {};
            checks[idx] = !checks[idx];
            localStorage.setItem(key, JSON.stringify(checks));
        }

        // --- 极致音频与语音逻辑 ---
        const VACUUM_SCRIPT = `好的，我们开始。
找一个舒服的姿势，让身体立起来，但不用用力。
先吸一口气，用鼻子。好。现在慢慢呼气，用嘴，把气吐干净。
轻轻地，把肚脐往里、往上收一点。就一点点。
好，三……二……一……放松。正常呼吸。
保持现在这个姿势。身体是直的，肩膀是松的。
我们再来一次。
用鼻子慢慢吸气，感觉空气进到肋骨两边。很好。
现在，用嘴巴慢慢呼气。不急，一点一点吐。直到，你感觉已经吐干净了。
好。这个时候，停一下。不吸气。
把肚脐，轻轻往里、往上带。就像拉上一条紧身拉链。肩膀别紧，胸腔保持打开。
很好，我们保持。
五……四……三……二……一……
好，慢慢放松。让呼吸自然回来。再吸一口气，然后完整地呼出去。`;

        function playSound(type) {
            if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const master = audioCtx.createGain();
            master.connect(audioCtx.destination);

            if(type === 'wind') {
                // 山谷风声合成
                const bufferSize = 2 * audioCtx.sampleRate;
                const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
                const data = buffer.getChannelData(0);
                for(let i=0; i<bufferSize; i++) data[i] = Math.random() * 2 - 1;
                
                const noise = audioCtx.createBufferSource();
                noise.buffer = buffer; noise.loop = true;
                const filter = audioCtx.createBiquadFilter();
                filter.type = 'lowpass'; filter.frequency.value = 300;
                
                const lfo = audioCtx.createOscillator();
                lfo.frequency.value = 0.15;
                const lfoGain = audioCtx.createGain(); lfoGain.gain.value = 200;
                
                noise.connect(filter); lfo.connect(lfoGain); lfoGain.connect(filter.frequency);
                filter.connect(master); master.gain.value = 0.1;
                noise.start(); lfo.start();
                oscillators.push(noise, lfo);
            } else {
                // 欢快音乐合成
                master.gain.value = 0.05;
                const notes = [261, 329, 392, 493, 523];
                const interval = setInterval(() => {
                    const osc = audioCtx.createOscillator();
                    const env = audioCtx.createGain();
                    osc.type = 'triangle';
                    osc.frequency.value = notes[Math.floor(Math.random()*notes.length)];
                    env.gain.setValueAtTime(0.05, audioCtx.currentTime);
                    env.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.3);
                    osc.connect(env); env.connect(master);
                    osc.start(); osc.stop(audioCtx.currentTime + 0.3);
                }, 400);
                oscillators.push({ stop: () => clearInterval(interval) });
            }
        }

        function speak(text, callback) {
            synth.cancel();
            const lines = text.split('\n').filter(l => l.trim());
            let i = 0;
            function next() {
                if(i >= lines.length) { if(callback) callback(); return; }
                document.getElementById('timerSubtitle').innerText = lines[i];
                const u = new SpeechSynthesisUtterance(lines[i]);
                u.lang = 'zh-CN'; u.rate = 0.9;
                u.onend = () => { i++; setTimeout(next, 800); };
                synth.speak(u);
            }
            next();
        }

        function startVacuum() {
            document.getElementById('timerOverlay').classList.remove('hidden');
            playSound('wind');
            let set = 1;
            const run = () => {
                document.getElementById('timerTitle').innerText = `真空腹呼吸 (组 ${set}/3)`;
                document.getElementById('timerDisplay').innerText = set;
                speak(VACUUM_SCRIPT, () => {
                    if(set < 3) { set++; setTimeout(run, 2000); }
                    else speak("可以了。今天，已经完成得很好了。", stopAll);
                });
            };
            run();
        }

        function startWalk() {
            document.getElementById('timerOverlay').classList.remove('hidden');
            document.getElementById('timerTitle').innerText = "餐后慢走";
            playSound('music');
            speak("15分钟慢走开始，跟着轻快的节奏。");
            let t = 900;
            timerInt = setInterval(() => {
                t--;
                const m = Math.floor(t/60), s = t%60;
                document.getElementById('timerDisplay').innerText = `${m}:${s<10?'0':''}${s}`;
                if(t<=0) {
                    clearInterval(timerInt);
                    speak("15分钟到了，你做的很棒！", stopAll);
                }
            }, 1000);
        }

        function stopAll() {
            synth.cancel();
            if(timerInt) clearInterval(timerInt);
            oscillators.forEach(o => o.stop ? o.stop() : o.disconnect());
            oscillators = [];
            if(audioCtx) audioCtx.close(); audioCtx = null;
            document.getElementById('timerOverlay').classList.add('hidden');
        }

        // --- 社交功能 (含视频限制) ---
        function validateVideo(input) {
            const file = input.files[0];
            if(!file) return;
            const video = document.createElement('video');
            video.preload = 'metadata';
            video.onloadedmetadata = () => {
                window.URL.revokeObjectURL(video.src);
                if(video.duration > 420) {
                    alert("视频太长啦！请限制在7分钟以内。");
                    input.value = "";
                }
            };
            video.src = URL.createObjectURL(file);
        }

        function postFeed() {
            const txt = document.getElementById('socialText').value;
            if(!txt) return;
            const posts = JSON.parse(localStorage.getItem('social_posts') || '[]');
            posts.unshift({
                txt: txt,
                time: new Date().toLocaleTimeString(),
                likes: 0
            });
            localStorage.setItem('social_posts', JSON.stringify(posts));
            document.getElementById('socialText').value = "";
            renderFeed();
        }

        function renderFeed() {
            const posts = JSON.parse(localStorage.getItem('social_posts') || '[]');
            document.getElementById('feedArea').innerHTML = posts.map((p, i) => `
                <div class="glass-card p-4">
                    <div class="flex items-center gap-2 mb-2">
                        <div class="w-8 h-8 rounded-full bg-black"></div>
                        <p class="text-xs font-bold">自律达人</p>
                        <span class="text-[9px] text-gray-400 ml-auto">${p.time}</span>
                    </div>
                    <p class="text-sm mb-3">${p.txt}</p>
                    <div class="flex gap-4 text-gray-400 text-xs border-t pt-2">
                        <span><i class="fa-regular fa-heart"></i> ${p.likes}</span>
                        <span><i class="fa-regular fa-comment"></i> 留言</span>
                    </div>
                </div>
            `).join('');
        }

        // --- 报表与分享 ---
        function createShareCard() {
            const cur = document.getElementById('p_c').value || 90;
            const diff = (90 - cur).toFixed(1);
            document.getElementById('shareWaistDiff').innerText = `-${diff}`;
            document.getElementById('shareDate').innerText = new Date().toLocaleDateString();
            document.getElementById('shareOverlay').style.display = 'flex';
        }

        function initCharts() {
            // 简单渲染，防止报错
            const ctx1 = document.getElementById('chartHabit');
            if(ctx1) new Chart(ctx1, {type:'bar', data:{labels:['M','T','W','T','F','S','S'], datasets:[{label:'Tasks', data:[12,15,18,14,16,10,12], backgroundColor:'#ff7eb9'}]}});
            
            const ctx2 = document.getElementById('chartWeight');
            if(ctx2) new Chart(ctx2, {type:'line', data:{labels:['1','2','3','4'], datasets:[{label:'KG', data:[65,64.5,64.2,63.8], borderColor:'#3b82f6'}]}});
            
            const ctx3 = document.getElementById('chartWaist');
            if(ctx3) new Chart(ctx3, {type:'line', data:{labels:['1','2','3','4'], datasets:[{label:'CM', data:[88,87,86.5,85], borderColor:'#10b981'}]}});
        }

        function switchTab(id) {
            document.getElementById('tab-tasks').classList.add('hidden');
            document.getElementById('tab-social').classList.add('hidden');
            document.getElementById('tab-stats').classList.add('hidden');
            document.getElementById('tab-'+id).classList.remove('hidden');
            
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            event.currentTarget.classList.add('active');
        }
    </script>
</body>
</html>
