<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <title>è¦ä¹–å“¦ | V13.0 Complete</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        :root { --accent: #ff7eb9; --bg-gradient: linear-gradient(135deg, #fdfbfb 0%, #ebedee 100%); }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg-gradient); min-height: 100vh; padding-top: 280px; padding-bottom: 100px; }
        
        /* ç»ç’ƒæ‹Ÿæ€ä¸ç»„ä»¶æ ·å¼ */
        .glass-card { background: rgba(255,255,255,0.85); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.6); border-radius: 16px; box-shadow: 0 4px 15px rgba(0,0,0,0.03); }
        .fixed-header { position: fixed; top: 0; left: 0; right: 0; z-index: 50; background: rgba(255,255,255,0.95); backdrop-filter: blur(20px); border-bottom: 1px solid rgba(0,0,0,0.05); padding: 1.2rem; }
        .check-custom { appearance: none; width: 22px; height: 22px; border: 2px solid #cbd5e1; border-radius: 6px; transition: 0.2s; position: relative; }
        .check-custom:checked { background: var(--accent); border-color: var(--accent); }
        .check-custom:checked::after { content: 'âœ”'; position: absolute; color: white; left: 5px; top: -1px; font-size: 14px; font-weight: bold; }
        .tab-btn.active { color: var(--accent); transform: scale(1.1); font-weight: 800; }
        .hidden { display: none !important; }
        
        /* åŠ¨ç”» */
        @keyframes pulse-slow { 0%, 100% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.05); opacity: 0.8; } }
        .breathing-circle { animation: pulse-slow 4s infinite ease-in-out; }
    </style>
</head>
<body>

    <header class="fixed-header">
        <div class="flex justify-between items-start mb-3">
            <div>
                <h1 class="text-2xl font-black italic tracking-tighter">è¦ä¹–å“¦<span class="text-pink-500">.</span></h1>
                <p class="text-[10px] text-gray-500 font-bold mt-1" id="currentDateDisplay">LOADING...</p>
            </div>
            <div class="text-right">
                <div class="bg-black text-white px-3 py-1 rounded-lg inline-block shadow-lg">
                    <p class="text-[8px] opacity-60 uppercase tracking-widest">TIMELINE</p>
                    <p class="text-xs font-bold" id="timelineDisplay">Day 1</p>
                </div>
            </div>
        </div>

        <div class="glass-card p-3 mb-2 grid grid-cols-2 gap-3">
            <div>
                <p class="text-[8px] text-gray-400 font-bold mb-1">æ€§åˆ« & ç›®æ ‡æ—¥æœŸ</p>
                <div class="flex gap-2">
                    <select id="p_gender" onchange="saveProfile()" class="bg-gray-50 rounded p-1 text-xs font-bold w-1/2 outline-none"><option value="female">å¥³ ğŸ‘§</option><option value="male">ç”· ğŸ‘¦</option></select>
                    <input id="p_goal_date" type="date" onchange="saveProfile()" class="bg-gray-50 rounded p-1 text-[10px] font-bold w-1/2 outline-none">
                </div>
            </div>
            <div>
                <p class="text-[8px] text-gray-400 font-bold mb-1">èº«é«˜ & ç›®æ ‡ä½“é‡</p>
                <div class="flex gap-2">
                    <input id="p_height" type="number" oninput="saveProfile()" placeholder="CM" class="bg-gray-50 rounded p-1 text-xs font-bold w-1/2 text-center outline-none">
                    <input id="p_goal" type="number" oninput="saveProfile()" placeholder="KG" class="bg-gray-50 rounded p-1 text-xs font-bold w-1/2 text-center text-green-600 outline-none">
                </div>
            </div>
        </div>
        
        <div class="grid grid-cols-2 gap-3">
            <div class="bg-pink-50/80 p-2 rounded-xl text-center border border-pink-100 relative">
                <p class="text-[8px] text-pink-400 font-bold uppercase">ä»Šæ—¥è…°å›´</p>
                <input id="today_waist" type="number" oninput="saveDaily()" class="w-full bg-transparent text-center font-black text-lg text-pink-600 outline-none" placeholder="0.0">
                <span class="text-[8px] absolute bottom-2 right-2 text-pink-300">CM</span>
            </div>
            <div class="bg-blue-50/80 p-2 rounded-xl text-center border border-blue-100 relative">
                <p class="text-[8px] text-blue-400 font-bold uppercase">ä»Šæ—¥ä½“é‡</p>
                <input id="today_weight" type="number" oninput="saveDaily()" class="w-full bg-transparent text-center font-black text-lg text-blue-600 outline-none" placeholder="0.0">
                <span class="text-[8px] absolute bottom-2 right-2 text-blue-300">KG</span>
            </div>
        </div>
    </header>

    <main class="px-5">
        
        <div id="tab-tasks" class="space-y-3 pb-24">
            <div id="taskListArea"></div>
        </div>

        <div id="tab-social" class="hidden pb-24 space-y-4">
            <div class="glass-card p-4">
                <textarea id="socialText" placeholder="ä»Šå¤©åšæŒå¾—æ€ä¹ˆæ ·ï¼Ÿ(é™7åˆ†é’Ÿè§†é¢‘/å›¾ç‰‡)" class="w-full bg-transparent outline-none text-sm h-16"></textarea>
                <div class="flex items-center gap-4 mt-2 border-t pt-2">
                    <label class="text-pink-500 cursor-pointer"><i class="fa-solid fa-image"></i><input type="file" accept="image/*" class="hidden"></label>
                    <label class="text-blue-500 cursor-pointer"><i class="fa-solid fa-video"></i><input type="file" accept="video/*" class="hidden" onchange="checkVideo(this)"></label>
                    <button onclick="alert('åŠ¨æ€å‘å¸ƒæˆåŠŸï¼(æ¨¡æ‹Ÿ)')" class="ml-auto bg-black text-white px-4 py-1 rounded-full text-xs font-bold">å‘å¸ƒ</button>
                </div>
            </div>
            <div class="glass-card p-4">
                <div class="flex items-center gap-2 mb-2"><div class="w-8 h-8 rounded-full bg-pink-200"></div><p class="text-xs font-bold">è‡ªå¾‹è¾¾äºº</p></div>
                <p class="text-sm text-gray-600">æ‰“å¡ç¬¬10å¤©ï¼Œè…°å›´çœŸçš„å°äº†ï¼</p>
            </div>
        </div>

        <div id="tab-stats" class="hidden space-y-5 pb-24">
            <div class="bg-gradient-to-br from-gray-900 to-gray-800 text-white p-5 rounded-2xl shadow-xl">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="text-xs font-bold opacity-50 uppercase">æœ¬å‘¨ AI æ€»ç»“</h3>
                    <span id="weekRate" class="text-xl font-black text-yellow-400">0%</span>
                </div>
                <p id="weekSummary" class="text-sm leading-relaxed italic text-gray-300">æ•°æ®ä¸è¶³ï¼Œè¯·å¼€å§‹æ‚¨çš„è‡ªå¾‹ä¹‹æ—…...</p>
            </div>

            <div class="glass-card p-4">
                <h3 class="text-xs font-black text-gray-400 mb-3 uppercase">è¿‘7å¤©æ‰“å¡ç»Ÿè®¡</h3>
                <canvas id="chartHabit" height="150"></canvas>
            </div>
            <div class="glass-card p-4">
                <h3 class="text-xs font-black text-gray-400 mb-3 uppercase">ä½“é‡è¶‹åŠ¿ (KG)</h3>
                <canvas id="chartWeight" height="150"></canvas>
            </div>
            <div class="glass-card p-4">
                <h3 class="text-xs font-black text-gray-400 mb-3 uppercase">è…°å›´è¶‹åŠ¿ (CM)</h3>
                <canvas id="chartWaist" height="150"></canvas>
            </div>
        </div>
    </main>

    <div id="mediaOverlay" class="hidden fixed inset-0 bg-white/95 z-[100] flex flex-col items-center justify-center p-8 text-center">
        <div id="visualCircle" class="w-64 h-64 bg-pink-100 rounded-full flex items-center justify-center mb-10 shadow-2xl breathing-circle hidden">
            <span class="text-4xl">ğŸ§˜â€â™€ï¸</span>
        </div>
        <div id="visualMusic" class="text-6xl animate-bounce mb-10 hidden">ğŸµ</div>
        
        <h2 id="mediaTitle" class="text-3xl font-black mb-2">å‡†å¤‡å¼€å§‹</h2>
        <p id="mediaTimer" class="text-6xl font-black text-gray-800 tabular-nums my-4">00:00</p>
        <p id="mediaSubtitle" class="text-gray-500 text-sm h-12">ä¿æŒä¸“æ³¨...</p>
        
        <button onclick="stopMedia()" class="mt-8 px-12 py-4 bg-black text-white rounded-full font-bold shadow-lg">ç»“æŸè®­ç»ƒ</button>
    </div>

    <nav class="fixed bottom-6 left-6 right-6 h-16 glass-card flex justify-around items-center px-2 z-50">
        <button onclick="switchTab('tasks')" class="tab-btn active w-1/3 text-xl"><i class="fa-solid fa-list-check"></i></button>
        <button onclick="switchTab('social')" class="tab-btn w-1/3 text-xl"><i class="fa-solid fa-users"></i></button>
        <button onclick="switchTab('stats')" class="tab-btn w-1/3 text-xl"><i class="fa-solid fa-chart-line"></i></button>
    </nav>

    <script>
        // --- æ ¸å¿ƒé…ç½® ---
        const DB_KEY = 'begood_v13_master';
        let db = {};
        let audioCtx = null;
        let activeInterval = null;
        let isPlaying = false;
        const synth = window.speechSynthesis;

        // --- å…¨é‡ä»»åŠ¡åˆ—è¡¨ (V5.0 å†…å®¹å›å½’) ---
        const TASKS_WORKDAY = [
            { t:'07:00', txt:'èµ·åºŠï¼šæ¸©æ°´ 300ml' },
            { t:'07:05', txt:'çœŸç©ºè…¹å‘¼å¸ 3ç»„', type:'vacuum' },
            { t:'07:20', txt:'ç«™å§¿å”¤é†’ 2åˆ†é’Ÿ' },
            { t:'07:30', txt:'æ—©é¤ï¼šè›‹ç™½+è”¬èœ' },
            { t:'07:45', txt:'å‡ºå‘å»å…¬å¸' },
            { t:'09:00', txt:'å¼€å¯å·¥ä½œæ¨¡å¼' },
            { t:'10:00', txt:'èµ·èº«æ´»åŠ¨+å–æ°´' },
            { t:'11:00', txt:'èµ·èº«æ´»åŠ¨+å–æ°´' },
            { t:'12:30', txt:'åˆé¤ï¼šç¢³æ°´+è›‹ç™½+è”¬èœ' },
            { t:'12:55', txt:'é¤åæ…¢èµ° 15åˆ†é’Ÿ', type:'walk' },
            { t:'14:30', txt:'èµ·èº«+å–æ°´' },
            { t:'15:30', txt:'èµ·èº«+å–æ°´' },
            { t:'16:30', txt:'èµ·èº«+å–æ°´' },
            { t:'18:10', txt:'å¼€è½¦å›å®¶' },
            { t:'19:00', txt:'åŠ›é‡/æœ‰æ°§è®­ç»ƒ' },
            { t:'20:00', txt:'æ™šé¤ï¼šè›‹ç™½+è”¬èœ+å°‘ç›' },
            { t:'21:00', txt:'çœŸç©ºè…¹å‘¼å¸ 3ç»„', type:'vacuum' },
            { t:'21:15', txt:'æ‹‰ä¼¸ã€æ”¾æ¾' },
            { t:'22:30', txt:'ä¸ŠåºŠå…¥ç¡' }
        ];

        const TASKS_WEEKEND = [
            { t:'09:30', txt:'èµ·åºŠï¼šæ¸©æ°´ 300ml' },
            { t:'09:35', txt:'çœŸç©ºè…¹å‘¼å¸ 3ç»„', type:'vacuum' },
            { t:'09:50', txt:'ç«™å§¿å”¤é†’ 2åˆ†é’Ÿ' },
            { t:'10:00', txt:'æ—©é¤ï¼šè›‹ç™½+è”¬èœ' },
            { t:'12:00', txt:'åˆé¤ï¼šç¢³æ°´+è›‹ç™½+è”¬èœ' },
            { t:'13:30', txt:'é¤åæ…¢èµ° 15åˆ†é’Ÿ', type:'walk' },
            { t:'19:00', txt:'æœ‰æ°§è®­ç»ƒ' },
            { t:'20:00', txt:'æ™šé¤ï¼šè›‹ç™½+è”¬èœ+å°‘ç›' },
            { t:'21:00', txt:'çœŸç©ºè…¹å‘¼å¸ 3ç»„', type:'vacuum' },
            { t:'21:15', txt:'æ‹‰ä¼¸ã€æ”¾æ¾' },
            { t:'23:30', txt:'ä¸ŠåºŠå…¥ç¡' }
        ];

        // --- åˆå§‹åŒ–é€»è¾‘ ---
        window.onload = () => {
            initDB();
            renderHeader();
            renderTaskList();
            loadTodayInputs();
        };

        function initDB() {
            const raw = localStorage.getItem(DB_KEY);
            if (raw) {
                db = JSON.parse(raw);
            } else {
                db = {
                    startDate: new Date().toISOString().split('T')[0], // é”æ­»åˆ›å»ºæ—¥æœŸ
                    profile: { gender:'female', height:'', goal:'', goal_date:'' },
                    history: {} 
                };
                saveDB();
            }
        }

        function saveDB() {
            localStorage.setItem(DB_KEY, JSON.stringify(db));
        }

        function renderHeader() {
            // æ—¥æœŸæ˜¾ç¤º
            const now = new Date();
            const dateStr = now.toLocaleDateString('zh-CN', { year:'numeric', month:'long', day:'numeric', weekday:'long' });
            document.getElementById('currentDateDisplay').innerText = dateStr;

            // æ—¶é—´è½´è®¡ç®—
            const start = new Date(db.startDate);
            const diff = Math.floor((now - start) / (1000*60*60*24));
            const dayNum = diff + 1;
            const weekNum = Math.ceil(dayNum / 7);
            document.getElementById('timelineDisplay').innerText = `ç¬¬${weekNum}å‘¨ Â· ç¬¬${dayNum}å¤©`;

            // å›å¡« Profile
            document.getElementById('p_gender').value = db.profile.gender;
            document.getElementById('p_height').value = db.profile.height;
            document.getElementById('p_goal').value = db.profile.goal;
            document.getElementById('p_goal_date').value = db.profile.goal_date;
        }

        // --- æ ¸å¿ƒä¸šåŠ¡ï¼šæ‰“å¡ä¸æ¯æ—¥é‡ç½® ---
        function renderTaskList() {
            const day = new Date().getDay();
            const isWeekend = (day === 0 || day === 6);
            const todayKey = new Date().toISOString().split('T')[0];
            
            // ç¡®ä¿ä»Šæ—¥æ•°æ®ç»“æ„å­˜åœ¨
            if (!db.history[todayKey]) db.history[todayKey] = { checks: [], weight: null, waist: null };
            
            const taskSource = isWeekend ? TASKS_WEEKEND : TASKS_WORKDAY;
            
            const html = taskSource.map((item, idx) => {
                const isChecked = db.history[todayKey].checks[idx] || false;
                return `
                <div class="glass-card p-4 flex justify-between items-center transition-all ${isChecked ? 'opacity-50' : ''}">
                    <div class="flex gap-4 items-start">
                        <span class="text-[10px] font-black text-gray-400 mt-1 w-8">${item.t}</span>
                        <div>
                            <p class="font-bold text-gray-800 text-sm ${isChecked ? 'line-through' : ''}">${item.txt}</p>
                            ${item.type === 'vacuum' ? 
                                `<button onclick="startVacuum()" class="mt-2 text-[10px] bg-pink-500 text-white px-3 py-1 rounded-full shadow hover:bg-pink-600"><i class="fa-solid fa-wind mr-1"></i>è¯­éŸ³å¼•å¯¼</button>` : ''}
                            ${item.type === 'walk' ? 
                                `<button onclick="startMusic()" class="mt-2 text-[10px] bg-blue-500 text-white px-3 py-1 rounded-full shadow hover:bg-blue-600"><i class="fa-solid fa-music mr-1"></i>å¼€å§‹æ…¢èµ°(éŸ³ä¹)</button>` : ''}
                        </div>
                    </div>
                    <input type="checkbox" class="check-custom" ${isChecked ? 'checked' : ''} onchange="toggleTask(${idx})">
                </div>
                `;
            }).join('');
            
            document.getElementById('taskListArea').innerHTML = `<p class="text-[10px] text-gray-400 font-bold mb-2 ml-1">${isWeekend ? 'WEEKEND MODE' : 'WORKDAY MODE'}</p>` + html;
        }

        function toggleTask(idx) {
            const todayKey = new Date().toISOString().split('T')[0];
            db.history[todayKey].checks[idx] = !db.history[todayKey].checks[idx];
            saveDB();
            renderTaskList(); // é‡ç»˜ä»¥æ›´æ–°æ ·å¼
        }

        // --- æ•°æ®å½•å…¥ ---
        function saveProfile() {
            db.profile.gender = document.getElementById('p_gender').value;
            db.profile.height = document.getElementById('p_height').value;
            db.profile.goal = document.getElementById('p_goal').value;
            db.profile.goal_date = document.getElementById('p_goal_date').value;
            saveDB();
        }

        function saveDaily() {
            const todayKey = new Date().toISOString().split('T')[0];
            db.history[todayKey].weight = document.getElementById('today_weight').value;
            db.history[todayKey].waist = document.getElementById('today_waist').value;
            saveDB();
            if(!document.getElementById('tab-stats').classList.contains('hidden')) renderCharts();
        }

        function loadTodayInputs() {
            const todayKey = new Date().toISOString().split('T')[0];
            if(db.history[todayKey]) {
                document.getElementById('today_weight').value = db.history[todayKey].weight || '';
                document.getElementById('today_waist').value = db.history[todayKey].waist || '';
            }
        }

        // --- éŸ³é¢‘å¼•æ“ (ä¿®å¤ç‰ˆ) ---
        function showMedia(type) {
            document.getElementById('mediaOverlay').classList.remove('hidden');
            document.getElementById('visualCircle').classList.add('hidden');
            document.getElementById('visualMusic').classList.add('hidden');
            
            if(type === 'vacuum') document.getElementById('visualCircle').classList.remove('hidden');
            if(type === 'music') document.getElementById('visualMusic').classList.remove('hidden');
        }

        function stopMedia() {
            document.getElementById('mediaOverlay').classList.add('hidden');
            synth.cancel();
            isPlaying = false;
            clearInterval(activeInterval);
            if(audioCtx) audioCtx.suspend();
        }

        // 1. çœŸç©ºè…¹è¯­éŸ³å¼•å¯¼ (V8.0 å†…å®¹)
        function startVacuum() {
            showMedia('vacuum');
            document.getElementById('mediaTitle').innerText = "çœŸç©ºè…¹è®­ç»ƒ";
            
            const steps = [
                "å‡†å¤‡å§¿åŠ¿ï¼Œå…¨èº«æ”¾æ¾...",
                "ç”¨é¼»å­æ·±å¸æ°”...æ„Ÿè§‰è‚‹éª¨æ‰©å¼ ...",
                "ç”¨å˜´å·´æ…¢æ…¢å‘¼æ°”...æŠŠæ°”åå¹²å‡€...",
                "ã€å±æ°”ã€‘æ”¶ç´§æ ¸å¿ƒï¼Œè‚šè„æ‰¾è„ŠæŸ±ï¼ä¿æŒï¼",
                "æ”¾æ¾ï¼Œè‡ªç„¶å‘¼å¸ã€‚"
            ];
            
            let set = 1;
            let stepIndex = 0;
            
            const runStep = () => {
                if(set > 3) {
                    speak("è®­ç»ƒå®Œæˆï¼Œéå¸¸æ£’ï¼");
                    setTimeout(stopMedia, 2000);
                    return;
                }
                
                document.getElementById('mediaTimer').innerText = `ç¬¬ ${set}/3 ç»„`;
                document.getElementById('mediaSubtitle').innerText = steps[stepIndex];
                speak(steps[stepIndex], () => {
                    stepIndex++;
                    if(stepIndex >= steps.length) {
                        stepIndex = 0;
                        set++;
                        setTimeout(runStep, 2000); // ç»„é—´ä¼‘æ¯
                    } else {
                        // å±æ°”ä¿æŒé€»è¾‘
                        if(stepIndex === 4) { // åˆšåˆšè¯»å®Œ"å±æ°”"
                            let hold = 5;
                            const hTimer = setInterval(() => {
                                document.getElementById('mediaSubtitle').innerText = `ä¿æŒ... ${hold}`;
                                hold--;
                                if(hold < 0) { clearInterval(hTimer); runStep(); }
                            }, 1000);
                        } else {
                            setTimeout(runStep, 1000);
                        }
                    }
                });
            };
            runStep();
        }

        function speak(txt, cb) {
            synth.cancel();
            const u = new SpeechSynthesisUtterance(txt);
            u.rate = 0.9;
            u.onend = cb;
            synth.speak(u);
        }

        // 2. æ¬¢å¿«æ…¢èµ°éŸ³ä¹ (Web Audio API ç”Ÿæˆï¼Œæ— éœ€å¤–é“¾)
        function startMusic() {
            showMedia('music');
            document.getElementById('mediaTitle').innerText = "æ¬¢å¿«æ…¢èµ°";
            document.getElementById('mediaSubtitle').innerText = "äº«å—è¿™ 15 åˆ†é’Ÿçš„å¾‹åŠ¨...";
            
            if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            audioCtx.resume();
            isPlaying = true;
            
            let timeLeft = 900; // 15åˆ†é’Ÿ
            activeInterval = setInterval(() => {
                timeLeft--;
                const m = Math.floor(timeLeft/60);
                const s = timeLeft%60;
                document.getElementById('mediaTimer').innerText = `${m}:${s<10?'0':''}${s}`;
                if(timeLeft <= 0) { stopMedia(); speak("15åˆ†é’Ÿæ…¢èµ°ç»“æŸï¼Œä½ å¤ªæ£’äº†ï¼"); }
            }, 1000);

            // ç”Ÿæˆä¸€æ®µè½»å¿«çš„ 8-bit ç¶éŸ³æ—‹å¾‹ Loop
            const notes = [261.6, 329.6, 392.0, 523.2, 392.0, 329.6]; // C E G C G E
            let noteIdx = 0;
            
            const playNextNote = () => {
                if(!isPlaying) return;
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.type = 'triangle';
                osc.frequency.value = notes[noteIdx % notes.length];
                
                gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.3);
                
                osc.connect(gain);
                gain.connect(audioCtx.destination);
                osc.start();
                osc.stop(audioCtx.currentTime + 0.4);
                
                noteIdx++;
                setTimeout(playNextNote, 250); // æ¯ç§’4ä¸ªéŸ³ç¬¦ï¼Œ120BPM
            };
            playNextNote();
        }

        function checkVideo(input) {
            const f = input.files[0];
            if(f && f.size > 100*1024*1024) alert("è§†é¢‘å¤ªå¤§å•¦ï¼"); // ç®€å•æ£€æŸ¥
        }

        // --- æŠ¥è¡¨ç³»ç»Ÿ (Charts) ---
        let chartRefs = {};
        
        function renderCharts() {
            // è·å–è¿‘7å¤© Keys
            const labels = [];
            const dataWeight = [];
            const dataWaist = [];
            const dataTasks = [];
            
            let totalTasks = 0;
            let activeDays = 0;
            
            for(let i=6; i>=0; i--) {
                const d = new Date();
                d.setDate(d.getDate() - i);
                const key = d.toISOString().split('T')[0];
                labels.push(d.toLocaleDateString('zh-CN', {month:'numeric', day:'numeric'}));
                
                const rec = db.history[key];
                if(rec) {
                    dataWeight.push(rec.weight);
                    dataWaist.push(rec.waist);
                    const done = (rec.checks || []).filter(Boolean).length;
                    dataTasks.push(done);
                    if(done > 0) activeDays++;
                    totalTasks += done;
                } else {
                    dataWeight.push(null);
                    dataWaist.push(null);
                    dataTasks.push(0);
                }
            }
            
            // æ›´æ–°æ€»ç»“
            const rate = activeDays > 0 ? Math.round(totalTasks / (activeDays * 15) * 100) : 0;
            document.getElementById('weekRate').innerText = rate + "%";
            document.getElementById('weekSummary').innerText = `è¿‡å»7å¤©ä½ æ´»è·ƒäº† ${activeDays} å¤©ï¼Œå…±å®Œæˆ ${totalTasks} é¡¹è‡ªå¾‹ä»»åŠ¡ã€‚${rate>80 ? 'çŠ¶æ€ç¥å‹‡ï¼' : 'ç»§ç»­åŠ æ²¹å“¦ï¼'}`;

            drawChart('chartHabit', 'bar', labels, dataTasks, '#ff7eb9');
            drawChart('chartWeight', 'line', labels, dataWeight, '#3b82f6');
            drawChart('chartWaist', 'line', labels, dataWaist, '#10b981');
        }

        function drawChart(id, type, labels, data, color) {
            if(chartRefs[id]) chartRefs[id].destroy();
            const ctx = document.getElementById(id).getContext('2d');
            chartRefs[id] = new Chart(ctx, {
                type: type,
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'æ•°å€¼',
                        data: data,
                        backgroundColor: color,
                        borderColor: color,
                        tension: 0.3,
                        spanGaps: true
                    }]
                },
                options: { responsive:true, plugins:{legend:{display:false}}, scales:{ y:{beginAtZero: false} } }
            });
        }

        function switchTab(t) {
            ['tasks','social','stats'].forEach(x => document.getElementById('tab-'+x).classList.add('hidden'));
            document.getElementById('tab-'+t).classList.remove('hidden');
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            event.currentTarget.classList.add('active');
            if(t === 'stats') renderCharts();
        }
    </script>
</body>
</html>
