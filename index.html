<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <title>è¦ä¹–å“¦ | Be Good V12.0 Real</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        :root { --accent: #ff7eb9; --bg-gradient: linear-gradient(135deg, #fdfbfb 0%, #ebedee 100%); }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg-gradient); min-height: 100vh; padding-top: 260px; padding-bottom: 100px; }
        .glass-card { background: rgba(255,255,255,0.8); backdrop-filter: blur(15px); border: 1px solid rgba(255,255,255,0.8); border-radius: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.02); }
        .fixed-header { position: fixed; top: 0; left: 0; right: 0; z-index: 50; background: rgba(255,255,255,0.9); backdrop-filter: blur(20px); border-bottom: 1px solid rgba(0,0,0,0.05); padding: 1.2rem; }
        .check-custom { appearance: none; width: 24px; height: 24px; border: 2px solid #cbd5e1; border-radius: 50%; transition: 0.2s; position: relative; }
        .check-custom:checked { background: var(--accent); border-color: var(--accent); }
        .check-custom:checked::after { content: 'âœ”'; position: absolute; color: white; left: 6px; top: 0; font-size: 14px; }
        .tab-btn.active { color: var(--accent); transform: scale(1.1); font-weight: bold; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <header class="fixed-header">
        <div class="flex justify-between items-start mb-3">
            <div>
                <h1 class="text-2xl font-black italic tracking-tighter">è¦ä¹–å“¦<span class="text-pink-500">.</span></h1>
                <p class="text-[10px] text-gray-400 mt-1" id="dateDisplay">LOADING...</p>
            </div>
            <div class="text-right">
                <div class="bg-black text-white px-3 py-1 rounded-lg inline-block shadow-lg">
                    <p class="text-[8px] opacity-70 uppercase tracking-widest">TIMELINE</p>
                    <p class="text-xs font-bold" id="timelineDisplay">Day 1</p>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-3 gap-2 mb-2">
            <select id="p_gender" onchange="saveProfile()" class="bg-white/50 rounded-lg p-2 text-xs font-bold outline-none text-center">
                <option value="female">ğŸ‘§ å¥³ç”Ÿ</option>
                <option value="male">ğŸ‘¦ ç”·ç”Ÿ</option>
            </select>
            <input id="p_height" type="number" oninput="saveProfile()" placeholder="èº«é«˜ cm" class="bg-white/50 rounded-lg p-2 text-center text-xs font-bold outline-none">
            <input id="p_goal_date" type="date" onchange="saveProfile()" class="bg-white/50 rounded-lg p-2 text-center text-[10px] font-bold outline-none text-gray-500">
        </div>
        
        <div class="grid grid-cols-3 gap-2 mb-3">
            <div class="bg-white p-2 rounded-lg text-center border border-gray-100"><p class="text-[8px] text-gray-400">å½“å‰ä½“é‡</p><input id="p_weight" type="number" oninput="saveDailyData()" class="w-full text-center font-black text-sm outline-none" placeholder="0.0"></div>
            <div class="bg-pink-50 p-2 rounded-lg text-center border border-pink-100"><p class="text-[8px] text-pink-400">å½“å‰è…°å›´</p><input id="p_waist" type="number" oninput="saveDailyData()" class="w-full text-center font-black text-sm outline-none text-pink-600" placeholder="0.0"></div>
            <div class="bg-green-50 p-2 rounded-lg text-center border border-green-100"><p class="text-[8px] text-green-500">ç›®æ ‡ä½“é‡</p><input id="p_goal" type="number" oninput="saveProfile()" class="w-full text-center font-black text-sm outline-none text-green-600" placeholder="0.0"></div>
        </div>
    </header>

    <main class="px-5">
        
        <div id="tab-tasks" class="space-y-3 pb-24"></div>

        <div id="tab-stats" class="hidden space-y-5 pb-24">
            <div class="bg-gradient-to-br from-gray-900 to-gray-800 text-white p-5 rounded-2xl shadow-xl">
                <h3 class="text-xs font-bold opacity-50 uppercase mb-2">æœ¬å‘¨ AI æ€»ç»“</h3>
                <p id="weekSummary" class="text-sm leading-relaxed italic">æš‚æ— è¶³å¤Ÿæ•°æ®ï¼Œè¯·å¼€å§‹ä»Šå¤©çš„æ‰“å¡å§ï¼</p>
            </div>

            <div class="glass-card p-4">
                <h3 class="text-xs font-black text-gray-400 mb-3 uppercase">è¿‘7å¤©æ‰“å¡å®Œæˆç‡</h3>
                <canvas id="chartHabit" height="150"></canvas>
            </div>
            <div class="glass-card p-4">
                <h3 class="text-xs font-black text-gray-400 mb-3 uppercase">ä½“é‡è¶‹åŠ¿ (KG)</h3>
                <canvas id="chartWeight" height="150"></canvas>
            </div>
            <div class="glass-card p-4">
                <h3 class="text-xs font-black text-gray-400 mb-3 uppercase">è…°å›´è¶‹åŠ¿ (CM)</h3>
                <canvas id="chartWaist" height="150"></canvas>
            </div>
        </div>

        <div id="tab-social" class="hidden pb-24 text-center pt-10 text-gray-400 text-xs">
            <p>ç¤¾äº¤åŠŸèƒ½æ¨¡å—è¿è¡Œæ­£å¸¸ (åŒV11.0)</p>
        </div>
    </main>

    <div id="playerOverlay" class="hidden fixed inset-0 bg-white/95 z-[100] flex flex-col items-center justify-center p-8">
        <div class="animate-bounce text-6xl mb-8">ğŸµ</div>
        <h2 id="playerTitle" class="text-2xl font-black mb-2">æ’­æ”¾ä¸­...</h2>
        <p id="playerTime" class="text-6xl font-black text-pink-500 tabular-nums my-6">15:00</p>
        <p class="text-gray-400 text-xs mb-10">è¯·ä¿æŒéŸ³é‡é€‚ä¸­ï¼Œäº«å—å¾‹åŠ¨</p>
        <button onclick="stopMusic()" class="px-10 py-3 bg-black text-white rounded-full font-bold">ç»“æŸè®­ç»ƒ</button>
    </div>

    <nav class="fixed bottom-6 left-6 right-6 h-16 glass-card flex justify-around items-center px-2 z-50">
        <button onclick="switchTab('tasks')" class="tab-btn active w-1/3 text-xl"><i class="fa-solid fa-list-check"></i></button>
        <button onclick="switchTab('social')" class="tab-btn w-1/3 text-xl"><i class="fa-solid fa-users"></i></button>
        <button onclick="switchTab('stats')" class="tab-btn w-1/3 text-xl"><i class="fa-solid fa-chart-line"></i></button>
    </nav>

    <script>
        // --- æ ¸å¿ƒé€»è¾‘å˜é‡ ---
        const DB_KEY = 'begood_v12_db'; // æ€»æ•°æ®åº“ Key
        let appData = {};
        let audioCtx = null;
        let musicTimer = null;
        let isPlaying = false;
        
        // --- 1. åˆå§‹åŒ–ä¸æ—¶é—´è½´ ---
        window.onload = () => {
            initDB();
            updateDateHeader();
            renderTasks();
            loadInputs();
        };

        function initDB() {
            const raw = localStorage.getItem(DB_KEY);
            if (raw) {
                appData = JSON.parse(raw);
            } else {
                // é¦–æ¬¡ä½¿ç”¨ï¼Œåˆå§‹åŒ–é”æ­»æ—¥æœŸ
                appData = {
                    profile: { gender: 'female', height: '', goal: '', goal_date: '' },
                    history: {}, // æ ¼å¼: "2026-02-09": { weight: 60, waist: 80, checks: [true, false...] }
                    startDate: new Date().toISOString().split('T')[0]
                };
                saveDB();
            }
        }

        function saveDB() {
            localStorage.setItem(DB_KEY, JSON.stringify(appData));
        }

        function updateDateHeader() {
            const now = new Date();
            const dateStr = now.toLocaleDateString('zh-CN', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' });
            document.getElementById('dateDisplay').innerText = dateStr;

            // è®¡ç®— Week X Day Y
            const start = new Date(appData.startDate);
            const diffTime = Math.abs(now - start);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
            const week = Math.ceil(diffDays / 7);
            const dayInWeek = diffDays % 7 || 7;
            
            document.getElementById('timelineDisplay').innerText = `ç¬¬${week}å‘¨ Â· ç¬¬${dayInWeek}å¤©`;
        }

        // --- 2. æ•°æ®ä¿å­˜ (Profile & Daily) ---
        function saveProfile() {
            appData.profile.gender = document.getElementById('p_gender').value;
            appData.profile.height = document.getElementById('p_height').value;
            appData.profile.goal = document.getElementById('p_goal').value;
            appData.profile.goal_date = document.getElementById('p_goal_date').value;
            saveDB();
        }

        function saveDailyData() {
            const today = new Date().toISOString().split('T')[0];
            if (!appData.history[today]) appData.history[today] = { checks: [] };
            
            appData.history[today].weight = parseFloat(document.getElementById('p_weight').value) || null;
            appData.history[today].waist = parseFloat(document.getElementById('p_waist').value) || null;
            saveDB();
            if(!document.getElementById('tab-stats').classList.contains('hidden')) renderCharts(); // å®æ—¶æ›´æ–°å›¾è¡¨
        }

        function loadInputs() {
            // Profile
            document.getElementById('p_gender').value = appData.profile.gender;
            document.getElementById('p_height').value = appData.profile.height;
            document.getElementById('p_goal').value = appData.profile.goal;
            document.getElementById('p_goal_date').value = appData.profile.goal_date;
            
            // Daily (Today)
            const today = new Date().toISOString().split('T')[0];
            if (appData.history[today]) {
                document.getElementById('p_weight').value = appData.history[today].weight || '';
                document.getElementById('p_waist').value = appData.history[today].waist || '';
            } else {
                // æ–°çš„ä¸€å¤©ï¼Œæ¸…ç©ºè¾“å…¥æ¡†
                document.getElementById('p_weight').value = '';
                document.getElementById('p_waist').value = '';
            }
        }

        // --- 3. ä»»åŠ¡é€»è¾‘ (æ¯æ—¥è‡ªåŠ¨åˆ·æ–°) ---
        function renderTasks() {
            const day = new Date().getDay();
            const isWeekend = (day === 0 || day === 6);
            const today = new Date().toISOString().split('T')[0];
            
            // ç¡®ä¿ä»Šå¤©çš„å†å²è®°å½•å­˜åœ¨
            if (!appData.history[today]) appData.history[today] = { checks: [] };
            
            let tasks = isWeekend ? [
                {t:'09:30', txt:'èµ·åºŠå–æ¸©æ°´'}, {t:'09:35', txt:'çœŸç©ºè…¹ 3ç»„', act:'vacuum'}, {t:'13:30', txt:'é¤åæ…¢èµ°', act:'walk'}, {t:'23:00', txt:'æ—©ç¡'}
            ] : [
                {t:'07:00', txt:'èµ·åºŠæ¸©æ°´'}, {t:'07:05', txt:'çœŸç©ºè…¹ 3ç»„', act:'vacuum'}, {t:'07:30', txt:'è¥å…»æ—©é¤'}, 
                {t:'12:55', txt:'é¤åæ…¢èµ°', act:'walk'}, {t:'19:00', txt:'æ¯æ—¥è®­ç»ƒ'}, {t:'22:30', txt:'ç¾å®¹è§‰'}
            ]; // *ç®€åŒ–ç¤ºä¾‹ï¼Œå®é™…è¯·å¡«å…¥æ‚¨ä¹‹å‰å®Œæ•´çš„é•¿åˆ—è¡¨*

            const container = document.getElementById('tab-tasks');
            container.innerHTML = tasks.map((t, i) => `
                <div class="glass-card p-4 flex justify-between items-center">
                    <div class="flex gap-3 items-center">
                        <span class="text-xs font-bold text-gray-400 w-10">${t.t}</span>
                        <div>
                            <p class="text-sm font-bold text-gray-800">${t.txt}</p>
                            ${t.act === 'walk' ? `<button onclick="startMusic(900)" class="text-[10px] bg-blue-100 text-blue-600 px-2 py-1 rounded mt-1">å¼€å§‹æ…¢èµ° 15min</button>` : ''}
                            ${t.act === 'vacuum' ? `<button onclick="startMusic(180)" class="text-[10px] bg-pink-100 text-pink-600 px-2 py-1 rounded mt-1">å¼€å§‹å‘¼å¸ 3min</button>` : ''}
                        </div>
                    </div>
                    <input type="checkbox" class="check-custom" ${appData.history[today].checks[i] ? 'checked' : ''} onchange="toggleCheck(${i})">
                </div>
            `).join('');
        }

        function toggleCheck(index) {
            const today = new Date().toISOString().split('T')[0];
            if(!appData.history[today].checks) appData.history[today].checks = [];
            appData.history[today].checks[index] = !appData.history[today].checks[index];
            saveDB();
        }

        // --- 4. çœŸå®éŸ³é¢‘å¼•æ“ (MusicBox) ---
        function startMusic(duration) {
            document.getElementById('playerOverlay').classList.remove('hidden');
            document.getElementById('playerTitle').innerText = duration === 900 ? "é¤åæ…¢èµ° BGM" : "çœŸç©ºè…¹è®¡æ—¶";
            
            if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            isPlaying = true;
            playMelody(); // å¯åŠ¨æ—‹å¾‹å¾ªç¯
            
            // å€’è®¡æ—¶
            let timeLeft = duration;
            clearInterval(musicTimer);
            musicTimer = setInterval(() => {
                timeLeft--;
                const m = Math.floor(timeLeft/60);
                const s = timeLeft%60;
                document.getElementById('playerTime').innerText = `${m}:${s<10?'0':''}${s}`;
                if(timeLeft <= 0) stopMusic();
            }, 1000);
        }

        function playMelody() {
            if(!isPlaying) return;
            // ä¸€ä¸ªç®€å•çš„Cå¤§è°ƒ Loop: C4, E4, G4, C5
            const notes = [261.63, 329.63, 392.00, 523.25];
            const now = audioCtx.currentTime;
            
            notes.forEach((freq, i) => {
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.type = 'square'; // æ–¹æ³¢å£°éŸ³æ›´å“äº®
                osc.frequency.value = freq;
                
                // åŒ…ç»œ
                gain.gain.setValueAtTime(0.05, now + i*0.5);
                gain.gain.exponentialRampToValueAtTime(0.001, now + i*0.5 + 0.4);
                
                osc.connect(gain);
                gain.connect(audioCtx.destination);
                osc.start(now + i*0.5);
                osc.stop(now + i*0.5 + 0.5);
            });

            // å¾ªç¯è°ƒç”¨
            setTimeout(playMelody, 2000); 
        }

        function stopMusic() {
            isPlaying = false;
            clearInterval(musicTimer);
            document.getElementById('playerOverlay').classList.add('hidden');
            if(audioCtx) audioCtx.suspend();
        }

        // --- 5. æŠ¥è¡¨ç³»ç»Ÿ (100% çœŸå®æ•°æ®) ---
        let chartInstances = {};

        function renderCharts() {
            // è·å–æœ€è¿‘7å¤©æ—¥æœŸ
            const dates = [];
            const today = new Date();
            for(let i=6; i>=0; i--) {
                const d = new Date(today);
                d.setDate(today.getDate() - i);
                dates.push(d.toISOString().split('T')[0]);
            }

            // å‡†å¤‡æ•°æ®
            const weightData = [];
            const waistData = [];
            const taskData = [];
            
            let completedTasks = 0;
            let totalDays = 0;

            dates.forEach(date => {
                const dayData = appData.history[date];
                if(dayData) {
                    weightData.push(dayData.weight || null); // null ä¼šå¯¼è‡´å›¾è¡¨æ–­å¼€ï¼ŒçœŸå®åæ˜ ç¼ºæ•°æ®
                    waistData.push(dayData.waist || null);
                    
                    const checks = dayData.checks || [];
                    const count = checks.filter(Boolean).length;
                    taskData.push(count);
                    
                    if(count > 0) totalDays++;
                    completedTasks += count;
                } else {
                    weightData.push(null);
                    waistData.push(null);
                    taskData.push(0);
                }
            });

            // æ›´æ–°å‘¨æ€»ç»“
            const rate = totalDays > 0 ? (completedTasks / (totalDays * 10) * 100).toFixed(0) : 0;
            document.getElementById('weekSummary').innerText = 
                totalDays === 0 ? "æœ¬å‘¨è¿˜æ²¡æœ‰æ‰“å¡æ•°æ®ï¼Œä»Šå¤©æ˜¯æ–°çš„å¼€å§‹ï¼" :
                `æœ¬å‘¨å·²æ‰“å¡ ${totalDays} å¤©ï¼Œå…±å®Œæˆ ${completedTasks} é¡¹ä»»åŠ¡ã€‚ç»¼åˆå®Œæˆç‡ ${rate}%ã€‚${rate>80?'éå¸¸è‡ªå¾‹ï¼Œç»§ç»­ä¿æŒï¼':'è¿˜éœ€è¦å†æ¥å†å‰å“¦ï¼'}`;

            // ç»˜åˆ¶å›¾è¡¨ (Chart.js)
            const createChart = (id, type, label, data, color) => {
                const ctx = document.getElementById(id);
                if(chartInstances[id]) chartInstances[id].destroy(); // é”€æ¯æ—§å›¾è¡¨é˜²æ­¢é‡å 
                
                chartInstances[id] = new Chart(ctx, {
                    type: type,
                    data: {
                        labels: dates.map(d => d.slice(5)), // åªæ˜¾ç¤º MM-DD
                        datasets: [{
                            label: label,
                            data: data,
                            borderColor: color,
                            backgroundColor: color + '33', // é€æ˜åº¦
                            tension: 0.4,
                            fill: true,
                            spanGaps: true // å…è®¸è¿çº¿å³ä½¿ä¸­é—´æœ‰æ–­ç‚¹
                        }]
                    },
                    options: { responsive: true, plugins: { legend: { display: false } } }
                });
            };

            createChart('chartHabit', 'bar', 'å®Œæˆä»»åŠ¡æ•°', taskData, '#ff7eb9');
            createChart('chartWeight', 'line', 'ä½“é‡ (kg)', weightData, '#3b82f6');
            createChart('chartWaist', 'line', 'è…°å›´ (cm)', waistData, '#10b981');
        }

        function switchTab(t) {
            document.querySelectorAll('main > div').forEach(d => d.classList.add('hidden'));
            document.getElementById('tab-'+t).classList.remove('hidden');
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            event.currentTarget.classList.add('active');
            if(t === 'stats') renderCharts();
        }
    </script>
</body>
</html>
